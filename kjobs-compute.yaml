# kjobs config for MARTI training
# Usage: kjobs submit -f kjobs-compute.yaml
#
# Before submitting, set WANDB_API_KEY in the command section or
# ensure the container image has W&B configured.
worker:
  cpu: 8
  memory: 64Gi
  gpu: 0
  image:
    repository: pytorch/pytorch
    tag: 2.5.1-cuda12.4-cudnn9-runtime
  command: |
    set -ex
    echo "=== MARTI Training Job ==="

    # Install system deps (git not in pytorch base image)
    apt-get update && apt-get install -y git 2>&1 | tail -5

    # W&B setup (set your API key)
    export WANDB_BASE_URL=https://cohere.wandb.io
    # export WANDB_API_KEY=<your-key>

    # Install Python deps
    pip install wandb loguru pydantic pydantic-settings python-dotenv transformers accelerate datasets 2>&1 | tail -10

    # Clone the repo
    git clone https://github.com/tongt1/multiagent.git /workspace/multiagent 2>&1 | tail -3
    cd /workspace/multiagent

    # Run training with CLI args (CPU-only)
    python -m src.training.train_marti \
      --pretrain-path HuggingFaceTB/SmolLM-135M \
      --trajectory-path data/sample_trajectories.jsonl \
      --save-path /workspace/checkpoints/marti_run_001 \
      --wandb-project marti-training \
      --wandb-run-name "marti-smolm-135m-reinforce" \
      --algorithm reinforce \
      --num-episodes 3 \
      --batch-size 8 \
      --learning-rate 1e-5

    echo "=== Training Complete ==="
  count: 1

namespace: default
queue: cpu-queue
app: marti-training
type: dynamic
