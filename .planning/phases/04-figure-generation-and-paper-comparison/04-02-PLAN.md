---
phase: 04-figure-generation-and-paper-comparison
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - scripts/generate_fig5.py
  - scripts/generate_fig6.py
  - figures/fig5_communication.pdf
  - figures/fig5_communication.png
  - figures/fig6_error_taxonomy.pdf
  - figures/fig6_error_taxonomy.png
autonomous: true
requirements:
  - FIG5-05
  - FIG6-03
  - COMP-01

must_haves:
  truths:
    - "Figure 5 PDF and PNG exist at figures/fig5_communication.{pdf,png}"
    - "Figure 5 has three panels: (a) success rates, (b) merge conflict rates, (c) speech acts & overhead"
    - "Figure 5 panel (a) shows 0% bars with Wilson CI upper bounds as error bars and annotation"
    - "Figure 5 panel (b) shows 41% vs 55% conflict rates with paper baseline reference lines"
    - "Figure 5 panel (c) shows speech act distribution (plan/question/update/other) with overhead annotation"
    - "Figure 6 PDF and PNG exist at figures/fig6_error_taxonomy.{pdf,png}"
    - "Figure 6 shows bar chart with 6 categories (C1a, C1b, C2, C3b, C4a, C4b) with count+pct annotations"
    - "Figure 6 has grouping brackets mapping our 6 categories to paper's 3 categories (Repetition, Unresponsiveness, Hallucination)"
    - "All figures use 300 DPI and TrueType fonts (pdf.fonttype=42)"
    - "Paper baseline numbers are overlaid on both figures for comparison"
  artifacts:
    - path: "scripts/generate_fig5.py"
      provides: "Figure 5 generation script"
      contains: "def main"
    - path: "scripts/generate_fig6.py"
      provides: "Figure 6 generation script"
      contains: "def main"
    - path: "figures/fig5_communication.pdf"
      provides: "Vector format Figure 5"
    - path: "figures/fig5_communication.png"
      provides: "Raster format Figure 5 at 300 DPI"
    - path: "figures/fig6_error_taxonomy.pdf"
      provides: "Vector format Figure 6"
    - path: "figures/fig6_error_taxonomy.png"
      provides: "Raster format Figure 6 at 300 DPI"
  key_links:
    - from: "scripts/generate_fig5.py"
      to: "scripts/paper_baselines.py"
      via: "import"
      pattern: "from paper_baselines import PAPER_BASELINES"
    - from: "scripts/generate_fig5.py"
      to: "data/fig5_metrics.json"
      via: "json.load"
      pattern: "json\\.load"
    - from: "scripts/generate_fig6.py"
      to: "scripts/paper_baselines.py"
      via: "import"
      pattern: "from paper_baselines import PAPER_BASELINES"
    - from: "scripts/generate_fig6.py"
      to: "data/fig6_metrics.json"
      via: "json.load"
      pattern: "json\\.load"
---

<objective>
Generate publication-quality Figure 5 (communication effects, 3-panel) and Figure 6 (error taxonomy bar chart) with paper baseline overlays.

Purpose: Complete the remaining two figures with paper comparison overlays. Figure 5 has the strongest signal in our data (merge conflict rates: 41% vs 55%). Figure 6 reveals the dominant error pattern (spammy = 74% of all errors). Both figures use the paper_baselines.py module created in Plan 04-01.

Output: `scripts/generate_fig5.py`, `scripts/generate_fig6.py`, `figures/fig5_communication.{pdf,png}`, `figures/fig6_error_taxonomy.{pdf,png}`
</objective>

<execution_context>
@/home/terry_tong_cohere_com/.claude/get-shit-done/workflows/execute-plan.md
@/home/terry_tong_cohere_com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-figure-generation-and-paper-comparison/04-RESEARCH.md
@.planning/phases/04-figure-generation-and-paper-comparison/04-01-SUMMARY.md
@data/fig5_metrics.json
@data/fig6_metrics.json
@scripts/paper_baselines.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Figure 5 — Communication effects 3-panel plot with paper overlay</name>
  <files>scripts/generate_fig5.py, figures/fig5_communication.pdf, figures/fig5_communication.png</files>
  <action>
Create `scripts/generate_fig5.py` that reads `data/fig5_metrics.json` and generates the 3-panel Figure 5.

**CRITICAL constraints (same as Fig 4):**
- Use system Python (`#!/usr/bin/env python3`), NOT the project venv
- `import sys; sys.path.insert(0, str(Path(__file__).resolve().parent))` for paper_baselines import
- `matplotlib.use("agg")` BEFORE importing pyplot
- Same rcParams and color scheme as generate_fig4.py (see 04-RESEARCH.md Pattern 1)

**Layout:** `plt.subplots(1, 3, figsize=(15, 5), gridspec_kw={"wspace": 0.35})`

**Panel (a): Success Rates**
- Grouped bars for coop_comm and coop_nocomm (both 0.0%)
- Colors: coop_comm=#6ACC65, coop_nocomm=#D65F5F
- Y-axis: "Success Rate (%)", ylim (0, 10) to show the empty bars clearly
- Add Wilson CI upper bound as error bars: `yerr=[[0, 0], [ci_upper_comm*100, ci_upper_nocomm*100]]` to show the uncertainty
- Data from fig5_metrics.json: `success_rates.coop_comm.{rate,ci_upper}`, `success_rates.coop_nocomm.{rate,ci_upper}`
- Annotate center: "0% in both settings" (gray, italic)
- Bar labels: "Comm\n(n=96)" and "No-Comm\n(n=88)"
- Title: "(a) Success Rates"

**Panel (b): Merge Conflict Rates** (strongest signal in our data)
- Grouped bars: comm=41%, nocomm=55%
- Data from fig5_metrics.json: `merge_conflict_rates.coop_comm.rate * 100`, `.coop_nocomm.rate * 100`
- Add percentage labels on top of bars (bold)
- Add Wilson CI as error bars
- Paper baseline reference lines (dashed, gray):
  - `ax.axhline(y=29.4, ...)` label "Paper: with planning (29.4%)"
  - `ax.axhline(y=51.5, ...)` label "Paper: without planning (51.5%)"
- Y-axis: "Merge Conflict Rate (%)"
- Title: "(b) Merge Conflict Rates"
- Legend showing paper reference lines

**Panel (c): Speech Acts & Communication Overhead**
- Bar chart with 4 categories: plan, question, update, other
- Data from fig5_metrics.json: `speech_acts.{plan,question,update,other}.pct`
- Use coop_comm color (#6ACC65) for all bars
- Add percentage labels on top of bars
- Paper baseline reference line at 33.3% (dashed, gray): "Paper: ~1/3 each"
- Annotate overhead in title: use `overhead.mean_pct` from metrics (22.8%)
- Add secondary annotation: "Paper overhead: ~20%"
- Title: "(c) Speech Acts (overhead: 22.8%)"

**Suptitle:** "Communication Effects: Comm vs No-Comm" (fontsize=14, fontweight="bold")

Use `plt.tight_layout()` after suptitle. Export to `figures/fig5_communication.{pdf,png}` at DPI=300.
  </action>
  <verify>
Run: `cd /mnt/data/terry/home/cooperbench-repro && python3 scripts/generate_fig5.py`

Then verify outputs:
```bash
ls -la figures/fig5_communication.pdf figures/fig5_communication.png
python3 -c "from PIL import Image; img = Image.open('figures/fig5_communication.png'); print(f'Size: {img.size}, DPI: {img.info.get(\"dpi\", \"unknown\")}')"
```

Expected: Both files exist, PNG DPI is (300, 300), no errors during generation, file sizes are non-trivial (>50KB for PNG).
  </verify>
  <done>
`figures/fig5_communication.{pdf,png}` exist at 300 DPI with three panels: (a) success rates showing 0% bars with CI error bars, (b) merge conflict rates (41% vs 55%) with paper planning baselines, (c) speech act distribution with overhead annotation. Paper comparison numbers are overlaid on panels (b) and (c).
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate Figure 6 — Communication error taxonomy bar chart with paper category mapping</name>
  <files>scripts/generate_fig6.py, figures/fig6_error_taxonomy.pdf, figures/fig6_error_taxonomy.png</files>
  <action>
Create `scripts/generate_fig6.py` that reads `data/fig6_metrics.json` and generates Figure 6.

**CRITICAL constraints (same as Fig 4/5):**
- Use system Python (`#!/usr/bin/env python3`), NOT the project venv
- `import sys; sys.path.insert(0, str(Path(__file__).resolve().parent))` for paper_baselines import
- `matplotlib.use("agg")` BEFORE importing pyplot
- Same rcParams and color scheme

**Figure design:**
1. Single axes, figsize=(10, 6)
2. Vertical bar chart with 6 categories on x-axis

**Data from fig6_metrics.json:**
- `frequency.{C1a,C1b,C2,C3b,C4a,C4b}.{count,pct_of_errors}`
- `summary.{total_errors,transcripts_with_errors,total_transcripts}`

**Bar chart:**
- 6 bars, one per category
- X-labels (2 lines): Category code + description:
  ```
  C1a: No Reply, C1b: Ignored, C2: Vague,
  C3b: Corrected, C4a: Same Info, C4b: Near-dup
  ```
- Y-axis: "% of Total Errors"
- Bar color: use a gradient or consistent color. Use coop_comm color (#6ACC65) for all bars.
- Add count + percentage annotations on top of each bar:
  ```
  n=32
  (41.6%)
  ```
- Y-axis range: auto, but ensure room for annotations

**Paper category grouping brackets (COMP-01):**
Use `matplotlib.patches.FancyBracketPatch` or manual annotation to add grouping brackets BELOW the x-axis (or above the bars) mapping our 6 categories to paper's 3:
- Bracket over C4a+C4b: "Repetition" (paper category)
- Bracket over C1a+C1b: "Unresponsiveness" (paper category)
- Bracket over C2+C3b: "Hallucination" (paper category)

Implementation approach: Use `ax.annotate` with `arrowprops` or draw bracket lines with `ax.plot` below the x-axis labels. Alternative: add a secondary colored bar at the bottom or top showing the paper's 3-category grouping with labels.

Preferred approach: Add colored underlines/rectangles beneath the x-axis labels with paper category names:
- Use `ax.text` positioned below the x-tick labels
- Draw horizontal line segments connecting the grouped categories
- Label each group with paper category name

**Subtitle annotation:** "77 errors across 51/100 transcripts (51% error rate)"
Use data from `summary` section of the JSON.

**Additional annotation (text box, bottom-right):**
```
Paper maps to 3 categories:
Repetition (C4a+C4b): 74.0%
Unresponsiveness (C1a+C1b): 20.8%
Hallucination (C2+C3b): 5.2%
(Paper exact % not reported)
```
Compute the aggregated percentages from our data to show our numbers mapped to paper's taxonomy.

**Title:** "Communication Error Taxonomy"

Export to `figures/fig6_error_taxonomy.{pdf,png}` at DPI=300.
  </action>
  <verify>
Run: `cd /mnt/data/terry/home/cooperbench-repro && python3 scripts/generate_fig6.py`

Then verify outputs:
```bash
ls -la figures/fig6_error_taxonomy.pdf figures/fig6_error_taxonomy.png
python3 -c "from PIL import Image; img = Image.open('figures/fig6_error_taxonomy.png'); print(f'Size: {img.size}, DPI: {img.info.get(\"dpi\", \"unknown\")}')"
```

Expected: Both files exist, PNG DPI is (300, 300), no errors during generation. Verify bar heights match expected data: C4a=41.6%, C4b=32.5%, C1a=11.7%, C1b=9.1%, C3b=3.9%, C2=1.3%.
  </verify>
  <done>
`figures/fig6_error_taxonomy.{pdf,png}` exist at 300 DPI. Figure shows 6-category bar chart with count/pct annotations, paper's 3-category grouping brackets, and aggregated mapping annotation. Spammy categories (C4a+C4b) visually dominate at 74% of errors.
  </done>
</task>

</tasks>

<verification>
1. `scripts/generate_fig5.py` runs without errors using system Python
2. `scripts/generate_fig6.py` runs without errors using system Python
3. `figures/fig5_communication.{pdf,png}` exist at 300 DPI
4. `figures/fig6_error_taxonomy.{pdf,png}` exist at 300 DPI
5. Figure 5 has 3 panels with correct data (0% success, 41%/55% conflict, speech act breakdown)
6. Figure 6 has 6 bars matching pct_of_errors from fig6_metrics.json
7. Paper baselines are overlaid on both figures
8. All 6 output files use consistent color scheme and publication-quality formatting
</verification>

<success_criteria>
Figures 5 and 6 are generated as PDF and PNG at publication quality (300 DPI, TrueType fonts). Figure 5 shows 3-panel communication effects with paper baseline reference lines. Figure 6 shows the 6-category error taxonomy with paper's 3-category grouping and aggregated comparison. All COMP-01 overlays are present.
</success_criteria>

<output>
After completion, create `.planning/phases/04-figure-generation-and-paper-comparison/04-02-SUMMARY.md`
</output>
