---
phase: 04-figure-generation-and-paper-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/paper_baselines.py
  - scripts/generate_fig4.py
  - figures/fig4_difficulty_curves.pdf
  - figures/fig4_difficulty_curves.png
autonomous: true
requirements:
  - FIG4-07
  - COMP-01

must_haves:
  truths:
    - "Figure 4 PDF and PNG exist at figures/fig4_difficulty_curves.{pdf,png}"
    - "Figure 4 shows difficulty-stratified success curves with scatter+line markers at 3 populated bucket centers (0.35, 0.65, 0.95)"
    - "CI shaded bands are visible around each data point using fill_between"
    - "AUC and retention values are annotated on the figure"
    - "Paper baseline numbers (pooled AUC solo=0.338, coop=0.200, retention=0.59) are overlaid as text annotation"
    - "Unpopulated buckets are visually distinguished from populated ones"
    - "Output DPI is 300+ and PDF uses TrueType fonts (fonttype 42)"
  artifacts:
    - path: "scripts/paper_baselines.py"
      provides: "Centralized paper baseline constants for all 3 figures"
      contains: "PAPER_BASELINES"
    - path: "scripts/generate_fig4.py"
      provides: "Figure 4 generation script"
      contains: "def main"
    - path: "figures/fig4_difficulty_curves.pdf"
      provides: "Vector format Figure 4"
    - path: "figures/fig4_difficulty_curves.png"
      provides: "Raster format Figure 4 at 300 DPI"
  key_links:
    - from: "scripts/generate_fig4.py"
      to: "scripts/paper_baselines.py"
      via: "import"
      pattern: "from paper_baselines import PAPER_BASELINES"
    - from: "scripts/generate_fig4.py"
      to: "data/fig4_metrics.json"
      via: "json.load"
      pattern: "json\\.load"
---

<objective>
Create the shared paper baselines module and generate publication-quality Figure 4 (difficulty-stratified success curves) with paper comparison overlay.

Purpose: Figure 4 is the most complex figure (sparse 3-bucket data with CI bands) and requires the shared paper_baselines.py module that all figure scripts will import. Building both together ensures the paper comparison pattern is established for Figures 5 and 6.

Output: `scripts/paper_baselines.py`, `scripts/generate_fig4.py`, `figures/fig4_difficulty_curves.{pdf,png}`
</objective>

<execution_context>
@/home/terry_tong_cohere_com/.claude/get-shit-done/workflows/execute-plan.md
@/home/terry_tong_cohere_com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-figure-generation-and-paper-comparison/04-RESEARCH.md
@data/fig4_metrics.json
@scripts/generate_phase1_figures.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create paper_baselines.py shared module</name>
  <files>scripts/paper_baselines.py</files>
  <action>
Create `scripts/paper_baselines.py` with a single `PAPER_BASELINES` dictionary containing all paper baseline constants needed by Figures 4, 5, and 6.

The module MUST include:

1. **fig4 baselines** (from paper Table 5):
   - Per-model AUC values: GPT-5 (solo=0.506, coop=0.325, retention=0.64), Claude 4.5 (0.469, 0.283, 0.60), MiniMax-M2 (0.374, 0.171, 0.46), Qwen-Coder (0.236, 0.148, 0.63), Qwen (0.106, 0.072, 0.68)
   - Pooled values: solo_auc=0.338, coop_auc=0.200, delta_auc=0.138, retention=0.59

2. **fig5 baselines** (from paper text):
   - comm_overhead_pct: 20.0
   - speech_acts: each ~1/3 (plan=33.3, question=33.3, update=33.3)
   - first_turn_planning: conflict_with=29.4%, conflict_without=51.5%

3. **fig6 baselines** (from paper Figure 5 description):
   - paper_categories: ["Repetition", "Unresponsiveness", "Hallucination"]
   - category_mapping: Repetition=C4a+C4b, Unresponsiveness=C1a+C1b, Hallucination=C2+C3b
   - Note that exact percentages are NOT available from paper text

4. **Figure number mapping** (critical for COMP-01):
   - Document that our Fig4=paper's Fig6 content, our Fig5=paper's Fig4, our Fig6=paper's Fig5

Add module docstring referencing arXiv:2601.13295 and explaining the mapping.

Use `#!/usr/bin/env python3` shebang. Pure constants, no imports needed beyond standard library.
  </action>
  <verify>
Run: `python3 -c "import sys; sys.path.insert(0, 'scripts'); from paper_baselines import PAPER_BASELINES; print('fig4 pooled:', PAPER_BASELINES['fig4']['pooled']); print('fig5 overhead:', PAPER_BASELINES['fig5']['comm_overhead_pct']); print('fig6 categories:', PAPER_BASELINES['fig6']['paper_categories'])"`

Expected: All three print statements succeed with correct values.
  </verify>
  <done>
`scripts/paper_baselines.py` exists with PAPER_BASELINES dict containing fig4/fig5/fig6 baselines and the paper-to-project figure number mapping documented in the docstring.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate Figure 4 â€” Difficulty-stratified success curves with paper overlay</name>
  <files>scripts/generate_fig4.py, figures/fig4_difficulty_curves.pdf, figures/fig4_difficulty_curves.png</files>
  <action>
Create `scripts/generate_fig4.py` that reads `data/fig4_metrics.json` and generates publication-quality Figure 4.

**CRITICAL constraints:**
- Use system Python (`#!/usr/bin/env python3`), NOT the project venv (no matplotlib in venv)
- `import sys; sys.path.insert(0, str(Path(__file__).resolve().parent))` to enable `from paper_baselines import PAPER_BASELINES`
- Use `matplotlib.use("agg")` BEFORE importing pyplot (headless server)
- NEVER call `plt.show()` -- only `fig.savefig()`

**Style setup (matching Phase 1 conventions, upgraded for publication):**
```python
plt.style.use("seaborn-v0_8-whitegrid")
plt.rcParams.update({
    "font.size": 11, "axes.labelsize": 12, "axes.titlesize": 13,
    "xtick.labelsize": 10, "ytick.labelsize": 10, "legend.fontsize": 9,
    "figure.facecolor": "white", "savefig.dpi": 300,
    "savefig.bbox": "tight", "savefig.pad_inches": 0.1,
    "pdf.fonttype": 42, "ps.fonttype": 42,
})
```

**Color scheme (from Phase 1):**
- solo: `#4878CF`, coop_comm: `#6ACC65`, coop_nocomm: `#D65F5F`, paper: `#888888`

**Figure design for sparse 3-bucket data:**
1. Single axes, figsize=(8, 5)
2. For each setting (solo, coop_comm, coop_nocomm):
   - Plot CI shaded bands using `fill_between` at each populated bucket center. Use narrow x-width bands (center +/- 0.03) since we have discrete points, not continuous curves.
   - Plot rate values as markers connected by lines (`-o`, markersize=7, linewidth=1.5, zorder=3)
3. X-axis: span [0, 1], tick marks at all 10 bucket centers (0.05 to 0.95 by 0.1)
4. Y-axis: span [-0.05, 1.05], label "Success Rate"
5. Shade unpopulated bucket regions in light gray (#f0f0f0, alpha=0.3) to distinguish from populated
6. Add text annotation box (top-left) with AUC comparison:
   ```
   Command A: Solo AUC=0.150, Coop AUC=0.000
   Retention: Comm=0.00, NoComm=0.00

   Paper (5 models, 10 buckets):
   Solo AUC=0.338, Coop AUC=0.200, Retention=0.59
   ```
7. Title: "Difficulty-Stratified Success Curves" with subtitle "(Command A, 3 of 10 difficulty buckets populated)"
8. Legend in upper right: Solo, Coop-Comm, Coop-NoComm

**Read data from fig4_metrics.json directly** -- the file has:
- `buckets[].center`, `buckets[].{solo,coop_comm,coop_nocomm}.{rate,ci_lower,ci_upper}`
- `auc.{solo,coop_comm,coop_nocomm}.value`
- `retention.{coop_comm,coop_nocomm}`

**Export:**
- Save as both PDF and PNG to `figures/` directory at project root
- Create `figures/` directory if it does not exist (`FIG_DIR.mkdir(parents=True, exist_ok=True)`)
- DPI=300 for both formats

Print confirmation message with file paths when done.
  </action>
  <verify>
Run: `cd /mnt/data/terry/home/cooperbench-repro && python3 scripts/generate_fig4.py`

Then verify outputs:
```bash
ls -la figures/fig4_difficulty_curves.pdf figures/fig4_difficulty_curves.png
python3 -c "from PIL import Image; img = Image.open('figures/fig4_difficulty_curves.png'); print(f'Size: {img.size}, DPI: {img.info.get(\"dpi\", \"unknown\")}')"
```

Expected: Both files exist, PNG DPI is (300, 300), no errors during generation.
  </verify>
  <done>
`figures/fig4_difficulty_curves.{pdf,png}` exist at 300 DPI. Figure shows 3 populated bucket data points with CI shaded bands, unpopulated regions marked, AUC/retention annotation with paper comparison text, and publication-quality formatting.
  </done>
</task>

</tasks>

<verification>
1. `scripts/paper_baselines.py` is importable and contains correct baseline values
2. `scripts/generate_fig4.py` runs without errors using system Python
3. `figures/fig4_difficulty_curves.pdf` exists (vector, TrueType fonts)
4. `figures/fig4_difficulty_curves.png` exists at 300 DPI
5. Figure shows scatter+line (NOT smooth curves) for 3 data points
6. CI shaded bands visible at each populated bucket
7. Paper comparison text annotation present
8. Unpopulated bucket regions visually distinguished
</verification>

<success_criteria>
Figure 4 PDF and PNG are generated at publication quality (300 DPI, TrueType fonts), showing difficulty-stratified success curves for 3 populated buckets with CI bands, paper baseline comparison text, and consistent color scheme. The paper_baselines.py module is importable by downstream figure scripts.
</success_criteria>

<output>
After completion, create `.planning/phases/04-figure-generation-and-paper-comparison/04-01-SUMMARY.md`
</output>
