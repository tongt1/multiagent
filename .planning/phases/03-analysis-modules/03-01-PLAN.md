---
phase: 03-analysis-modules
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/analyze_fig4.py
  - data/fig4_metrics.json
autonomous: true
requirements: [FIG4-03, FIG4-04, FIG4-05, FIG4-06]

must_haves:
  truths:
    - "Per-bucket solo and coop success rates are computed for all 3 populated buckets (3, 6, 9)"
    - "Wilson 95% confidence intervals are computed for every rate, including p=0 and small-n edge cases"
    - "AUC is computed via trapezoidal integration over populated bucket centers only (not all 10 buckets)"
    - "Retention metric (AUC_coop / AUC_solo) is computed, handling AUC_solo=0 edge case"
    - "Solo rates use seed=0 only (100 records), not inflated by seed 1/2"
    - "Empty buckets are excluded from AUC computation, not treated as rate=0"
    - "Records with eval_error are excluded from rate computations"
  artifacts:
    - path: "scripts/analyze_fig4.py"
      provides: "Figure 4 analysis script computing per-bucket rates, CIs, AUC, retention"
      min_lines: 120
    - path: "data/fig4_metrics.json"
      provides: "Structured JSON output consumed by Phase 4 figure generation"
  key_links:
    - from: "scripts/analyze_fig4.py"
      to: "data/results.json"
      via: "json.load reads unified results store"
      pattern: "json\\.load.*results\\.json"
    - from: "scripts/analyze_fig4.py"
      to: "data/fig4_metrics.json"
      via: "json.dump writes metrics output"
      pattern: "json\\.dump.*fig4_metrics"
---

<objective>
Compute all Figure 4 statistical metrics: per-bucket solo and coop success rates, Wilson 95% confidence intervals, AUC via trapezoidal integration, and retention ratio. Handles sparse data (3 of 10 buckets populated, ~1% solo pass rate, 0% coop pass rate) with correct edge-case behavior.

Purpose: Produces the core statistical data for Figure 4 (difficulty-stratified success curves). This is the primary metric showing the coordination gap between solo and cooperative performance.

Output: `scripts/analyze_fig4.py` (rerunnable analysis script) and `data/fig4_metrics.json` (structured metrics for Phase 4).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-analysis-modules/03-RESEARCH.md
@data/results.json
@scripts/collect_results.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Figure 4 analysis script</name>
  <files>scripts/analyze_fig4.py</files>
  <action>
Create `scripts/analyze_fig4.py` -- a pure-Python script (stdlib only: json, math, collections, pathlib, argparse, sys) that reads `data/results.json` and writes `data/fig4_metrics.json`.

**1. Wilson CI function:**
```python
def wilson_ci(successes: int, total: int) -> tuple[float, float]:
```
- z=1.96 for 95% CI
- Handle n=0: return (0.0, 1.0)
- Handle p=0 and p=1 correctly (Wilson is well-behaved at boundaries)
- Round to 6 decimal places

**2. Trapezoidal AUC function:**
```python
def trapezoidal_auc(x: list[float], y: list[float]) -> float:
```
- Requires len(x) >= 2, else return 0.0
- Standard trapezoidal rule: sum((x[i+1]-x[i]) * (y[i]+y[i+1]) / 2)

**3. Data loading and filtering:**
- Load `data/results.json`
- Filter out records where `eval_error is not None`
- Filter out records where `infra_error is True`
- For solo rates: use ONLY `seed == 0` (100 records, matching coop denominator). This avoids inflating solo denominators with seed 1/2. Per research recommendation and project decision.
- For coop rates: use both `coop-comm` and `coop-nocomm` settings (100 records each)

**4. Per-bucket rate computation:**
- Group records by `(setting, bucket)` where setting is one of: `solo`, `coop-comm`, `coop-nocomm`
- For each group: count `both_passed == True` as successes, total records as denominator
- Compute rate = successes / total (0 if total=0)
- Compute Wilson CI for each rate
- Bucket centers: `center = 0.05 + 0.1 * bucket` (e.g., bucket 3 -> 0.35, bucket 6 -> 0.65, bucket 9 -> 0.95)
- Only include populated buckets in output (skip buckets with no data for ANY setting)

**5. AUC computation:**
- For each setting (solo, coop_comm, coop_nocomm):
  - Collect (center, rate) pairs from populated buckets where that setting has data
  - Sort by center (should already be sorted)
  - If < 2 points: AUC = 0.0 with a warning
  - Else: compute trapezoidal AUC
- Include n_points and x_range in AUC output

**6. Retention computation:**
- retention_coop_comm = AUC_coop_comm / AUC_solo if AUC_solo > 0 else None
- retention_coop_nocomm = AUC_coop_nocomm / AUC_solo if AUC_solo > 0 else None
- Note: with 0% coop pass rate, both AUC_coop will be 0.0, so retention will be 0.0

**7. Output schema (data/fig4_metrics.json):**
```json
{
    "buckets": [
        {
            "bucket": 3,
            "center": 0.35,
            "solo": {"successes": N, "total": N, "rate": F, "ci_lower": F, "ci_upper": F},
            "coop_comm": {"successes": N, "total": N, "rate": F, "ci_lower": F, "ci_upper": F},
            "coop_nocomm": {"successes": N, "total": N, "rate": F, "ci_lower": F, "ci_upper": F}
        }
    ],
    "auc": {
        "solo": {"value": F, "n_points": N, "x_range": [F, F]},
        "coop_comm": {"value": F, "n_points": N, "x_range": [F, F]},
        "coop_nocomm": {"value": F, "n_points": N, "x_range": [F, F]}
    },
    "retention": {
        "coop_comm": F_or_null,
        "coop_nocomm": F_or_null
    },
    "metadata": {
        "input_file": "data/results.json",
        "total_records": N,
        "records_used": N,
        "solo_seed": 0,
        "populated_buckets": [3, 6, 9],
        "total_buckets": 10,
        "sparsity_warning": "Only 3 of 10 buckets populated; AUC is a rough approximation"
    }
}
```

**8. CLI and console output:**
- Support `--input` and `--output` arguments with defaults
- Print human-readable summary to stdout: per-bucket rates, AUC values, retention
- Use PROJECT_ROOT = Path(__file__).resolve().parent.parent for path defaults

**Expected values (from research validation):**
- Bucket 3 solo: 2/3 passed = 66.7%, CI (0.2077, 0.9385)
- Bucket 6 solo: 0/1 passed = 0%, CI (0.0, 0.7935)
- Bucket 9 solo: 1/98 passed = 1.02%, CI (0.0018, 0.0545) approximately
- All coop buckets: 0% pass rate
- Solo AUC: small positive value from the 3 populated points
- Coop AUC: 0.0 (all rates are 0)
- Retention: 0.0

NOTE: The exact bucket 3 values depend on which task_ids fall in bucket 3 and their seed=0 results. The research found 2/3 passed for bucket 3 solo -- verify against actual data during execution.
  </action>
  <verify>
  - `python scripts/analyze_fig4.py` runs without errors and prints summary
  - `python -c "import json; d=json.load(open('data/fig4_metrics.json')); print(len(d['buckets']))"` returns 3 (populated buckets only)
  - `python -c "import json; d=json.load(open('data/fig4_metrics.json')); print(d['metadata']['populated_buckets'])"` returns [3, 6, 9]
  - `python -c "import json; d=json.load(open('data/fig4_metrics.json')); print(d['auc']['solo']['value'] > 0)"` returns True (solo has non-zero AUC)
  - `python -c "import json; d=json.load(open('data/fig4_metrics.json')); print(d['auc']['coop_comm']['value'])"` returns 0.0 (coop has zero AUC)
  - `python -c "import json; d=json.load(open('data/fig4_metrics.json')); b=d['buckets'][0]; print(b['solo']['ci_lower'] >= 0 and b['solo']['ci_upper'] <= 1)"` returns True (CIs are valid)
  - All buckets have Wilson CIs where lower >= 0 and upper <= 1
  </verify>
  <done>scripts/analyze_fig4.py produces data/fig4_metrics.json with per-bucket rates for 3 populated buckets, Wilson 95% CIs, AUC via trapezoidal integration, and retention metrics. Solo uses seed=0 only. Empty buckets excluded. Edge cases (p=0, n=0, AUC_solo=0) handled correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Validate Figure 4 metrics against known data properties</name>
  <files></files>
  <action>
Run inline validation to confirm all Figure 4 metrics are consistent with the known data properties from Phase 2.

**Validation checks:**

1. **Bucket count:** Exactly 3 populated buckets (3, 6, 9)
2. **Solo seed filtering:** Solo total across all buckets should sum to approximately 100 (seed=0 only, minus eval errors for solo seed 0). Specifically:
   - Count solo seed=0 records without eval_error in results.json
   - Compare to sum of solo.total across fig4_metrics.json buckets
   - They must match
3. **Coop totals:** coop_comm total should be approximately 100, coop_nocomm approximately 100 (minus eval errors)
4. **Wilson CI bounds:** For every rate, ci_lower >= 0 and ci_upper <= 1. For p=0, ci_lower should be exactly 0.0. For all CIs, ci_lower <= rate <= ci_upper.
5. **Wilson CI specific checks:**
   - wilson_ci(0, 100) should produce ci_upper near 0.037 (0% pass rate with n=100)
   - wilson_ci(0, 0) should produce (0.0, 1.0)
6. **AUC consistency:** AUC_solo should be a small positive number (since bucket 3 has non-zero solo rate). AUC_coop_comm and AUC_coop_nocomm should be exactly 0.0 (all rates are 0).
7. **Retention:** Both retention values should be 0.0 (since coop AUC is 0, and solo AUC > 0).
8. **No inflation:** Verify that no solo bucket has total > 100 (would indicate seed 1/2 leaked in).
9. **Metadata fields:** All metadata fields present and populated_buckets matches actual bucket list.

Print PASS/FAIL for each check. If any FAIL, investigate and fix analyze_fig4.py, then re-run.
  </action>
  <verify>
  - All 9 validation checks print PASS
  - No assertion errors
  </verify>
  <done>Figure 4 metrics validated: 3 populated buckets, correct Wilson CIs, correct AUC computation, solo uses seed=0 only, retention correctly computed. Ready for Phase 4 figure generation.</done>
</task>

</tasks>

<verification>
1. `scripts/analyze_fig4.py` exists and is executable
2. `data/fig4_metrics.json` exists with valid JSON
3. Exactly 3 populated buckets (3, 6, 9) in output
4. Solo rates use seed=0 only (total across buckets ~ 100 minus eval errors)
5. Wilson CIs have valid bounds (0 <= lower <= rate <= upper <= 1)
6. AUC computed over populated buckets only
7. Retention = AUC_coop / AUC_solo with edge case handling
8. Script is rerunnable (idempotent)
</verification>

<success_criteria>
- data/fig4_metrics.json contains per-bucket rates with Wilson CIs for all 3 settings
- AUC values are computed via trapezoidal integration over populated buckets
- Retention metric is available as a named output
- Solo rates use seed=0 only (no seed inflation)
- All edge cases handled: p=0, n=0, empty buckets, AUC_solo=0
- Script runs in < 5 seconds (500 records, pure computation)
</success_criteria>

<output>
After completion, create `.planning/phases/03-analysis-modules/03-01-SUMMARY.md`
</output>
