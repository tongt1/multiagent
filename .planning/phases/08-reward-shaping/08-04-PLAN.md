---
phase: "08"
plan: "04"
type: integration
autonomous: true
wave: 2
depends_on: ["08-01", "08-02", "08-03"]
---

# Phase 08 Plan 04: Reward Shaping Integration

## Objective

Wire the reward shaping registry (08-01 through 08-03) into the training pipeline so that strategies can be selected via SWEEP config and applied during training. Add integration tests verifying end-to-end flow from config to shaped rewards.

## Context

The reward shaping package (`src/training/reward_shaping/`) provides five strategies (identity, difference_rewards, reward_mixing, coma_advantage, potential_based) with a registry-based plugin architecture. These strategies are currently standalone - they need to be connected to:

1. The SWEEP config so users can select a strategy via config
2. The DebateMetricStreamer so shaped rewards are logged to W&B
3. Integration tests that verify the full pipeline from config to output

## Tasks

### Task 1: Add RewardShapingConfig to SWEEP config infrastructure
type="auto"

Add a `reward_shaping` configuration section to the DebateMetricStreamerConfig so that reward shaping strategy can be selected alongside existing debate enrichment. This keeps reward shaping co-located with the debate metrics pipeline where rewards are already being processed.

**Done criteria:**
- DebateMetricStreamerConfig has `reward_shaping_strategy` and `reward_shaping_params` fields
- Default values produce identity (passthrough) behavior
- Config accepts any registered strategy name

### Task 2: Wire reward shaping into DebateMetricStreamer
type="auto"

Modify the DebateMetricStreamer to instantiate a reward shaping strategy from config and apply it during get(). The shaped rewards should be logged as additional W&B metrics alongside existing debate metrics.

**Done criteria:**
- DebateMetricStreamer creates a RewardShaper from config at init time
- shaped rewards are computed and logged as `debate/shaped_reward/{role}` metrics
- Original (unshaped) metrics remain unchanged for backward compatibility
- Errors in reward shaping are caught and logged without breaking the pipeline

### Task 3: Add integration tests for config-to-shaped-rewards flow
type="auto"

Write integration tests that verify the full pipeline: config dict -> create_strategy_from_config -> shape_rewards -> correct output for each strategy. Also test the DebateMetricStreamer integration.

**Done criteria:**
- Tests cover all 5 strategies via config creation
- Tests verify DebateMetricStreamer produces shaped reward metrics
- Tests verify backward compatibility (no config = identity behavior)
- All tests pass

### Task 4: Add reward shaping strategy to SWEEP config example
type="auto"

Update the sweep_math_debate_grpo.py config to include a commented-out reward_shaping_strategy parameter showing how to enable non-identity strategies. This serves as documentation for experiment runners.

**Done criteria:**
- SWEEP config shows reward_shaping_strategy parameter in DebateMetricStreamerConfig
- Comment explains available strategies and how to switch
- Default remains identity (no behavior change)

## Verification

```bash
uv run pytest tests/test_reward_shaping_integration.py tests/test_reward_shaping_registry.py tests/test_reward_mixing.py tests/test_difference_rewards.py tests/test_coma_advantage.py tests/test_potential_shaping.py -v
```

## Success Criteria

- All reward shaping strategies are accessible via SWEEP config
- DebateMetricStreamer applies reward shaping and logs shaped metrics
- Existing behavior unchanged when no reward shaping is configured
- Integration tests pass for all strategies
- SWEEP config documents how to enable reward shaping

## Output

- Modified: `src/training/wandb_enrichment/debate_streamer.py`
- Modified: `configs/sweep_math_debate_grpo.py`
- Created: `tests/test_reward_shaping_integration.py`
